{{/* 
  TODO: validate input: 
    - src and selector string and required
    - widths array of int's, optional
    - provide error messages
    - check width is not greater than image width and remove if it 
    - if removed=true add an extra width, if image width is tollerance wider than the new widest width
  */}}
  {{- /*
    bg-images/private/variables.html
    Generates variables and returns dict of variables
    @author @sean-au
  
    @context - page context

    @returns dict:
      .images - array of all images for processing (dict)
      .selectors - comma delimited string of all bg image selectors
      .lazy_selectors - json array of lazy load selectors for use in JS
  
    @access private
  
    @example - Hugo Template
    {{ $variables := partial "bg-images/private/variables" . }}
  
  */ -}}
{{ $images := slice }}
{{ $selectors := slice }}
{{ $lazy_selectors := slice}}

{{ range where site.Pages "Params.bg_images" "!=" nil }}
  {{ $ctx := .}}
  {{ range .Params.bg_images}}
    {{/* sanitize user inputs */}}
    {{ partial "bg-images/private/sanitize-inputs" (merge . (dict "ctx" $ctx)) }}
    {{/* santize widths */}}
    {{ $new_widths := partial "bg-images/private/utils/sanitize-widths" (dict 
      "page" $ctx
      "img" ($ctx.Resources.Get .src)
      "widths" (.widths | default site.Params.bg_images.widths)
      "fill_ratio" false
      "difference" (site.Params.bg_images.min_width_difference | int)
      "suppress" site.Params.bg_images.suppress_width_warning ) }}
    {{/* add values to slices for export below */}}
    {{ $image := merge . (dict "ctx" $ctx "widths" $new_widths) }}
    {{ $images = $images | append $image }}
    {{ $selectors = $selectors | append .selector }}
    {{ if .lazy }}
      {{ $lazy_selectors = $lazy_selectors | append .selector }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* delimit for css usage */}}
{{ $selectors = delimit $selectors ", "}}
{{/* jsonlify for js usage */}}
{{ $lazy_selectors = jsonify $lazy_selectors }}

{{/* return variables in dict */}}
{{ return dict 
  "images" $images
  "selectors" $selectors
  "lazy_selectors" $lazy_selectors }}
