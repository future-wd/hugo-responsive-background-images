{{ $images := slice }}
{{ $selectors := slice }}
{{ $lazy_selectors := slice }}
{{ $not_lazy_selectors := slice }}

{{/* import sanitized site config params */}}
{{ $config := partial "bg-images/private/params/collect" (merge site.Params.bg_images (dict "level" "site")) }}
{{ warnf "site config: %v" $config}}

{{/* check for images, and their params and merge }}

{{ range where site.Pages "Params.bg_images" "!=" nil }}
  {{ $ctx := . }}
  {{ with .Params.bg_images }}
    {{ errorf "page exists"}}
    {{ $page_config := partial "bg-images/private/params/collect" (merge . (dict "level" "page")) }}
    {{ warnf "page %v config: %v" $ctx.RelPermalink $page_config}}
    {{ $config = merge $config $page_config}}
    {{ warnf "page config merged: %v" $config}}

    {{ range .images }}
      {{ $image_config := partial "bg-images/private/params/collect" .}}
      {{ warnf "image config: %v" $image_config}}
      {{ $config = merge $config $image_config}}
      {{ warnf "image config merged: %v" $config}}

    {{ $widths = sort $widths }}
    {{ $sanitized_widths := partial "bg-images/private/utils/sanitize-widths" (dict 
      "ctx" $ctx
      "img" ($ctx.Resources.Get $image.src)
      "widths" $widths
      "fill_ratio" false
      "difference" $config.difference
      "suppress" $config.suppress ) }}
    {{ end }}
  {{ end }}

{{ end }}

{{/* return variables in dict */}}
{{ return dict 
  "images" $images
  "selectors" $selectors
  "lazy_selectors" $lazy_selectors
  "not_lazy_selectors" $not_lazy_selectors
  "config" $config }}
